{% extends 'base.html' %}
{% block content %}

<h5>Add Return Invoice here.</h5>

<form id="invoiceForm" method="POST" action="{% url 'return_invoice_add' %}">
    {% csrf_token %}
    <input type="hidden" name="action_type" id="action_type" value="add_update">
    <input type="hidden" name="product_id" id="product_id" value="">
    <input type="hidden" name="update_action" id="update_action" value="">
    <div class = 'row' style = " background: radial-gradient(circle at 18.7% 37.8%, rgb(250, 250, 250) 0%, rgb(225, 234, 238) 90%);; border-radius: 5px;padding: 5px;height: 300px;">
        <div class = "col-4 col-md-3">
            <label for = "{{ invoice_form.Return_Id.id_for_label}}"><b>{{invoice_form.Return_Id.label}}</b></label>
            {{invoice_form.Return_Id}}
        </div>
        <div class = "col-4 col-md-3">
            <label for = "{{ invoice_form.Return_Date.id_for_label}}"><b>{{invoice_form.Return_Date.label}}</b></label>
            {{invoice_form.Return_Date}}
        </div>
        <div class = "col-4 col-md-3 align-self">
            <label for = "{{ invoice_form.To_Company_Name.id_for_label}}"><b>{{invoice_form.To_Company_Name.label}}</b></label>
            {{invoice_form.To_Company_Name}}
        </div>
        <div class = "col-4 col-md-3">
            <label for = "{{ invoice_form.From_Company_Name.id_for_label}}"><b>{{invoice_form.From_Company_Name.label}}</b></label>
            {{invoice_form.From_Company_Name}}
        </div>
        <div class = "form-floating">
            {{invoice_form.To_Address}}
            <label for = "{{ invoice_form.To_Address.id_for_label}}"><b>{{invoice_form.To_Address.label}}</b></label>
        </div>
        <div class = "form-floating">
            {{invoice_form.From_Address}}
            <label for = "{{ invoice_form.From_Address.id_for_label}}"><b>{{invoice_form.From_Address.label}}</b></label>
        </div>
    </div>
</form>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<!-- Ensure Select2 is loaded -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script>
    function initializeCompanySelect2(selector) {
        console.log("Initializing Select2 for selector:", selector);
        $(selector).select2({
            ajax: {
                url: "{% url 'ajax_load_companies' %}",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    console.log("AJAX request params:", params);
                    return {
                        term: params.term
                    };
                },
                processResults: function (data) {
                    console.log("Received data:", data);
                    return {
                        results: $.map(data, function (item) {
                            return { id: item.Company_name, text: item.Company_name };
                        })
                    };
                },
                error: function(xhr, status, error) {
                    console.error("Error in AJAX request:", error);
                }
            },
            placeholder: 'Select a manufacturer',
            minimumInputLength: 1,
            width: 'resolve'
        }).on('select2:select', function (e) {
            var data = e.params.data;
            fetchCompanyAddress(data.id);
        });
    }

    function fetchCompanyAddress(companyName) {
        console.log("Fetching address for company:", companyName);
        fetch(`/get_company_address?company_name=${companyName}`)
            .then(response => response.json())
            .then(data => {
                console.log("Received data:", data);
                document.getElementById('id_To_Address').value = data.address;
            })
            .catch(error => {
                console.error("Error fetching address:", error);
            });
    }

    $(document).ready(function () {
        console.log("Document is ready. Initializing Select2.");
        initializeCompanySelect2('#id_To_Company_Name');
    });

</script>
{% endblock %}