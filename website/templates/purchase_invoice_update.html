{% extends 'base.html' %}
{% block content %}

{% if user.is_authenticated %}

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<style>
    .material-symbols-outlined {
      font-variation-settings:
      'FILL' 0,
      'wght' 400,
      'GRAD' 0,
      'opsz' 40
    }

</style>
<form id="invoiceForm" method="POST" action="{% url 'purchase_invoice_update' PI_invoice_form.Invoice_Id.value %}">

    <div class="position-relative">
        <div class="position-absolute top-0 end-0">
            <button type="button" class="btn btn-secondary" onclick="refreshPage('{{ PI_invoice_form.Invoice_Id.value }}')" style="
                display: flex; 
                justify-content: center;
                align-items: center;
                height: 3vw;
                border-radius: 0.315vw;
                font-weight: bold;
                text-align: center;
                transition: 0.7s ease-in-out transform, 0.7s ease-in-out;">
                <span class="material-symbols-outlined">
                    refresh
                </span> Refresh
            </button>
        </div>
    </div>
<br><br><br>

    {% csrf_token %}
    <input type="hidden" name="action_type" id="action_type" value="add_update">
    <input type="hidden" name="product_id" id="product_id" value="">
    <input type="hidden" name="update_action" id="update_action" value="">
    <div class = 'row' style = " background: radial-gradient(circle at 18.7% 37.8%, rgb(250, 250, 250) 0%, rgb(225, 234, 238) 90%);; border-radius: 5px;padding: 5px;height: 75px;">
        <div class = "col-4 col-md-3">
            <label for = "{{ PI_invoice_form.Invoice_Id.id_for_label}}"><b>{{PI_invoice_form.Invoice_Id.label}}:</b></label>
            <input type="text" name="Invoice_Id" class="form-control" placeholder="Enter Invoice Id" maxlength="255" readonly value="{{ PI_invoice_form.Invoice_Id.value }}" id="id_Invoice_Id">
            <!-- {{invoice_form.Invoice_Id}} -->
        </div>
        <div class = "col-4 col-md-3">
            <label for = "{{ PI_invoice_form.Invoice_Date.id_for_label}}"><b>{{PI_invoice_form.Invoice_Date.label}}</b></label>
            {{PI_invoice_form.Invoice_Date}}
        </div>
        <div class = "col-4 col-md-3 align-self">
            <label for = "{{ PI_invoice_form.Company_Name.id_for_label}}"><b>{{PI_invoice_form.Company_Name.label}}</b></label>
            {{PI_invoice_form.Company_Name}}
        </div>
        <div class = "col-4 col-md-3">
            <label for = "{{ PI_invoice_form.Address.id_for_label}}"><b>{{PI_invoice_form.Address.label}}</b></label>
            {{PI_invoice_form.Address}}
        </div>
    </div>
<br>
<div style = "background: linear-gradient(to top, #c4c5c7 0%, #dcdddf 52%, #ebebeb 100%); border-radius: 5px;padding: 5px;height: 350px;">
    {% csrf_token %}
    <div class = 'row'>
     <div class = "col-4 col-md-3 align-self">
            <label for = "{{ PI_product_form.Product_Name.id_for_label}}"><b>{{PI_product_form.Product_Name.label}}</b></label>
            {{PI_product_form.Product_Name}}
        </div> 

    <div class = "col-4 col-md-3">
                <label for = "{{ PI_product_form.Batch_No.id_for_label}}"><b>{{PI_product_form.Batch_No.label}}</b></label>
                {{PI_product_form.Batch_No}}
            </div>

            <div class = "col-4 col-md-3">
                <label for = "{{ PI_product_form.Manufacture_date.id_for_label}}"><b>{{PI_product_form.Manufacture_date.label}}</b></label>
                {{PI_product_form.Manufacture_date}}
            </div>

            <div class = "col-4 col-md-3">
                <label for = "{{ PI_product_form.Expiry_date.id_for_label}}"><b>{{PI_product_form.Expiry_date.label}}</b></label>
                {{PI_product_form.Expiry_date}}
            </div>
        </div>
        <br>
        <div class = "row">
            <div class = "col-4 col-md-3">
                <label for = "{{ PI_product_form.Size.id_for_label}}"><b>{{PI_product_form.Size.label}}</b></label>
                {{PI_product_form.Size}}
            </div>

            <div class = "col-4 col-md-3">
                <label for = "{{ PI_product_form.Unit.id_for_label}}"><b>{{PI_product_form.Unit.label}}</b></label>
                {{PI_product_form.Unit}}
            </div>

            <div class = "col-4 col-md-3">
                <label for = "{{ PI_product_form.Quantity.id_for_label}}"><b>{{PI_product_form.Quantity.label}}</b></label>
                {{PI_product_form.Quantity}}
            </div>

            <div class = "col-4 col-md-3">
                <label for = "{{ PI_product_form.BT_Rate.id_for_label}}"><b>{{PI_product_form.BT_Rate.label}}</b></label>
                {{PI_product_form.BT_Rate}}
            </div>

        </div>
        <br>
        <div class = 'row'>
            <div class = "col-4 col-md-3">
                <label for = "{{ PI_product_form.BT_Final_Amount.id_for_label}}"><b>{{PI_product_form.BT_Final_Amount.label}}</b></label>
                {{PI_product_form.BT_Final_Amount}}
            </div>

            <div class = "col-4 col-md-3">
                <label for = "{{ PI_product_form.CGST.id_for_label}}"><b>{{PI_product_form.CGST.label}}</b></label>
                {{PI_product_form.CGST}}
            </div>

            <div class = "col-4 col-md-3">
                <label for = "{{ PI_product_form.SGST.id_for_label}}"><b>{{PI_product_form.SGST.label}}</b></label>
                {{PI_product_form.SGST}}
            </div>

            <div class = "col-4 col-md-3">
                <label for = "{{ PI_product_form.PU_Final_Amount.id_for_label}}"><b>{{PI_product_form.PU_Final_Amount.label}}</b></label>
                {{PI_product_form.PU_Final_Amount}}
            </div>
        </div> 
        <br>
        <div class = 'row'>
            <div class = "col-4 col-md-3">
                <label for = "{{ price_form.MRP.id_for_label}}"><b>MRP</b></label>
                {{price_form.MRP}}
            </div>

            <div class = "col-4 col-md-3">
                <label for = "{{ price_form.Cost_Price.id_for_label}}"><b>Cost Price</b></label>
                {{price_form.Cost_Price}}
            </div>

            <div class = "col-4 col-md-3">
                <label for = "{{ price_form.Profit_percentage.id_for_label}}"><b>Profit percentage</b></label>
                {{price_form.Profit_percentage}}
            </div>

            <div class = "col-4 col-md-3">
                <label for = "{{ price_form.Selling_Price.id_for_label}}"><b>Selling Price</b></label>
                {{price_form.Selling_Price}}
            </div>
        </div>
        <br><br>
        <button type="submit" class="btn btn-success" onclick="document.getElementById('action_type').value='add_update'">Add +</button>
    </div>
<br><br><br>
<div class = 'table-responsive'style = "overflow:scroll;  height:300px; margin-top:20px; width: 100%; white-space: nowrap;" >
<table class="table table-hover table-bordered" >
   <thead class = 'table-dark' style = "position: sticky; top: 0px;">
       <th id="product_id">Id</th>
       <th>Product Name</th>
       <th>Batch No</th>
       <th>Manufacture Date</th>
       <th>Expiry Date</th>
       <th>Size</th>
       <th>Quantity</th>
       <th>Before Tax Rate</th>
       <th>Before Tax Final Amount</th>
       <th>CGST</th>
       <th>SGST</th>
       <th>After Tax Final Amount</th>
       <th>MRP</th>
       <th>Cost Price</th>
       <th>Profit percentage</th>
       <th>Selling Price</th>
   </thead>
   {% for data in product_record%}
    {% if data.Flag != 'Yes' %}
   <tr>
    <td>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal{{ data.Id }}">
            {{ data.Id }}
        </button>
        <!-- Modal Starts -->
        <div class="modal fade" id="modal{{ data.Id }}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel"><b>Update or Delete</b></h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {{ data.Product_Name }}
                    </div>
                    <div class="modal-footer">
                        <!-- <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Update</button> -->
                        <button type="button" class="btn btn-outline-primary" onclick="populateFormForUpdate
                        (
                            JSON.stringify({
                                'Id': '{{ data.Id|escapejs }}',
                                'Product_Name': '{{ data.Product_Name|escapejs }}',
                                'Batch_No': '{{ data.Batch_No|escapejs }}',
                                'Manufacture_date': '{{ data.Manufacture_date|escapejs }}',
                                'Expiry_date': '{{ data.Expiry_date|escapejs }}',
                                'Size': '{{ data.Size|escapejs }}',
                                'Unit': '{{ data.Unit|escapejs }}',
                                'Quantity': '{{ data.Quantity|escapejs }}',
                                'BT_Rate': '{{ data.BT_Rate|escapejs }}',
                                'BT_Final_Amount': '{{ data.BT_Final_Amount|escapejs }}',
                                'CGST': '{{ data.CGST|escapejs }}',
                                'SGST': '{{ data.SGST|escapejs }}',
                                'PU_Final_Amount': '{{ data.PU_Final_Amount|escapejs }}',
                                'MRP':'{{data.MRP|escapejs}}',
                                'Cost_Price':'{{data.Cost_Price|escapejs}}',
                                'Profit_percentage':'{{data.Profit_percentage|escapejs}}',
                                'Selling_Price':'{{data.Selling_Price|escapejs}}',
                            })
                        )" data-bs-dismiss="modal">Update</button>
                        <button type="button" class="btn btn-outline-danger" onclick="setDeleteActionAndSubmit('{{ data.Id }}')" data-bs-dismiss="modal">Delete</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal Ends -->
    </td>
    <!-- <td>{{ data.Id }}</td> -->
    <td>{{ data.Product_Name }}</td>
    <td>{{ data.Batch_No }}</td>
    <td>{{ data.Manufacture_date }}</td>
    <td>{{ data.Expiry_date }}</td>
    <td>{{ data.Size }} {{ data.Unit }}</td>
    <!-- <td>{{ data.Unit }}</td> -->
    <td>{{ data.Quantity}}</td>
    <td>{{ data.BT_Rate }}</td>
    <td>{{ data.BT_Final_Amount }}</td>
    <td>{{ data.CGST }}</td>
    <td>{{ data.SGST }}</td>
    <td><b>{{ data.PU_Final_Amount }}</b></td>
    <td>{{data.MRP}}</td>
    <td>{{data.Cost_Price}}</td>
    <td>{{ data.Profit_percentage }} %</td>
    <td>{{ data.Selling_Price }} ₹</td>
    <!-- <td><input type="hidden" name="product_id" value="{{ data.Id }}">
    <input type="hidden" name="delete_product" value="1">
    <button class="btn btn-outline-danger" type="submit">Delete</button></td> -->
   </tr>
   {% endif %}
   {%endfor%}
 </table>
</div>
<br>
<br>
    <b>Price Summary:</b>
    <br><br>
        {% csrf_token %}
       <div class = 'row' style = "background: linear-gradient(to top, #accbee 0%, #e7f0fd 100%); border-radius: 5px;padding: 5px;height: 300px;">
        <div class = "col-4 col-md-3">
            <label for = "{{ PI_price_form.Final_Amount.id_for_label}}"><b>{{PI_price_form.Final_Amount.label}}</b></label>
            {{PI_price_form.Final_Amount}}
        </div>
        <div class = "col-4 col-md-3">
            <label for = "{{ PI_price_form.Additions.id_for_label}}"><b>{{PI_price_form.Additions.label}}</b></label>
            {{PI_price_form.Additions}}
        </div>
        <div class = "col-4 col-md-3">
            <label for = "{{ PI_price_form.Deductions.id_for_label}}"><b>{{PI_price_form.Deductions.label}}</b></label>
            {{PI_price_form.Deductions}}
        </div>
        <div class = "col-4 col-md-3">
            <label for = "{{ PI_price_form.Revised_Amount.id_for_label}}"><b>{{PI_price_form.Revised_Amount.label}}</b></label>
            {{PI_price_form.Revised_Amount}}
        </div>
    
        <div class="form-floating">
            {{PI_price_form.Comments}}
            <label for="{{ PI_price_form.Revised_Amount.id_for_label}}">{{PI_price_form.Comments.label}}</label>
          </div>
       </div>
    
       <br><br>
       <button type="submit" class="btn btn-success" id="updateButton">Update</button>
       <a href="{% url 'purchase_invoice' %}" class="btn btn-secondary">Back</a>
    </form>
    <br>
    <br>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<!-- Ensure Select2 is loaded -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script>
    //disables invoice id field//
    // document.addEventListener('DOMContentLoaded', function() {
    //     document.querySelector('[name="{{ invoice_form.Invoice_Id.name }}"]').disabled = true;
    // });
    //***********************//
    function initializeCompanySelect2(selector,initialValue) {
        console.log("Initializing Select2 for selector:", selector);
        $(selector).select2({
            ajax: {
                url: "{% url 'ajax_load_companies' %}",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    console.log("AJAX request params:", params);
                    return {
                        term: params.term
                    };
                },
                processResults: function (data) {
                    console.log("Received data:", data);
                    return {
                        results: $.map(data, function (item) {
                            return { id: item.Company_name, text: item.Company_name };
                        })
                    };
                },
                error: function(xhr, status, error) {
                    console.error("Error in AJAX request:", error);
                }
            },
            placeholder: 'Select a manufacturer',
            minimumInputLength: 1,
            width: 'resolve'
        }).on('select2:select', function (e) {
            var data = e.params.data;
            fetchCompanyAddress(data.id);
        });

        if (initialValue) {
            var newOption = new Option(initialValue.text, initialValue.id, true, true);
            $(selector).append(newOption).trigger('change');
        }
    }

    function fetchCompanyAddress(companyName) {
        console.log("Fetching address for company:", companyName);
        fetch(`/get_company_address?company_name=${companyName}`)
            .then(response => response.json())
            .then(data => {
                console.log("Received data:", data);
                document.getElementById('id_Address').value = data.address;
            })
            .catch(error => {
                console.error("Error fetching address:", error);
            });
    }
    $(document).ready(function () {
        console.log("Document is ready. Initializing Select2.");
        var initialManufacturer = {
            id: "{{ company_name }}",
            text: "{{ company_name }}"
        };
        initializeCompanySelect2('#id_Company_Name',initialManufacturer);
    });

// Product Name Ajax
function initializeProductSelect2(selector) {
        console.log("Initializing Select2 for selector:", selector);
        $(selector).select2({
            ajax: {
                url: "{% url 'get_product_name' %}",
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    console.log("AJAX request params:", params);
                    return {
                        term: params.term
                    };
                },
                processResults: function (data) {
                    console.log("Received data:", data);
                    return {
                        results: $.map(data, function (item) {
                            return { id: item.Name, text: item.Name };
                        })
                    };
                },
                error: function(xhr, status, error) {
                    console.error("Error in AJAX request:", error);
                }
            },
            placeholder: 'Select a manufacturer',
            minimumInputLength: 1,
            width: 'resolve'
        })
    }

    $(document).ready(function () {
        console.log("Document is ready. Initializing Select2.");
        initializeProductSelect2('#id_Product_Name');
    });
//Profit Percentage Ajax--
    $(document).ready(function() {
    function fetchProfitPercentage() {
        var productName = $('#id_Product_Name').val();
        // var batchNo = $('#id_Batch_No').val();
        var size = $('#id_Size').val();
        var unit = $('#id_Unit').val();

        if (productName && size && unit) {
            $.ajax({
                url: '{% url "get_profit_percentage" %}',
                data: {
                    'product_name': productName,
                    // 'batch_no': batchNo,
                    'size': size,
                    'unit': unit,
                },
                success: function(data) {
                    if (data.profit_percentage !== null) {
                        $('#id_Profit_percentage').val(data.profit_percentage);
                    } else {
                        $('#id_Profit_percentage').val(''); // Clear the field if no data found
                    }
                }
            });
        }
    }

    // Attach the function to the change event of relevant fields
    $('#id_Product_Name, #id_Size, #id_Unit').change(fetchProfitPercentage);
});

    // Auto calculated fields..
function calculateBTFA(){
    var Quantity = parseInt(document.getElementById('id_Quantity').value) || 0;
    var BT_Rate = parseFloat(document.getElementById('id_BT_Rate').value) || 0;

    var BT_Final_Amount = Quantity * BT_Rate;
    document.getElementById('id_BT_Final_Amount').value = BT_Final_Amount.toFixed(2);

    // Call calculateATFA to update the After Tax Final Amount
    calculateATFA();
}
document.addEventListener("DOMContentLoaded", function() {
        function setDeleteActionAndSubmit(productId) {
            const actionTypeElement = document.getElementById('action_type');
            // const productIdElement = document.getElementById('product_id');
            const formElement = document.getElementById('invoiceForm');
            
            if (actionTypeElement && formElement) {
                actionTypeElement.value = 'delete';
                productIdElement.value = productId;
                formElement.submit();
            } else {
                console.error("One or more elements are missing from the DOM.");
            }
        }

        // Ensure setDeleteActionAndSubmit is available globally
        window.setDeleteActionAndSubmit = setDeleteActionAndSubmit;
    });

function calculateATFA(){
    var BT_Final_Amount = parseFloat(document.getElementById('id_BT_Final_Amount').value) || 0;
    var cgst = parseFloat(document.getElementById('id_CGST').value) || 0;
    var sgst = parseFloat(document.getElementById('id_SGST').value) || 0;

    var cgst_amt = BT_Final_Amount * (cgst / 100);
    var sgst_amt = BT_Final_Amount * (sgst / 100);
    var AT_Final_Amount = BT_Final_Amount + cgst_amt + sgst_amt;

    document.getElementById('id_PU_Final_Amount').value = AT_Final_Amount.toFixed(2);
}

document.addEventListener('DOMContentLoaded', function(){
    var inputsBTFA = document.querySelectorAll('#id_Quantity, #id_BT_Rate');
    inputsBTFA.forEach(function(input) {
        input.addEventListener('input', calculateBTFA);
    });

    var inputsATFA = document.querySelectorAll('#id_BT_Final_Amount, #id_CGST, #id_SGST');
    inputsATFA.forEach(function(input) {
        input.addEventListener('input', calculateATFA);
    });

    // Add event listeners to BT_Final_Amount for both calculations
    var btFinalAmountInput = document.getElementById('id_BT_Final_Amount');
    if (btFinalAmountInput) {
        btFinalAmountInput.addEventListener('input', calculateATFA);
    }
});

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function populateFormForUpdate(productData) {
    const data = JSON.parse(productData);
    document.getElementById('update_action').value = 'update';
    document.getElementById('product_id').value = data.Id;

    // Set the value for the Product_Name select2 field
    var productNameSelect = $('#id_Product_Name');
    var newOption = new Option(data.Product_Name, data.Product_Name, true, true);
    productNameSelect.append(newOption).trigger('change');

    // document.getElementById('update_action').value = 'update';
    // document.getElementById('product_id').value = data.Id;
    // document.getElementById('id_Product_Name').value = data.Product_Name;
    document.getElementById('id_Batch_No').value = data.Batch_No;
    document.getElementById('id_Manufacture_date').value = formatDate(data.Manufacture_date);
    document.getElementById('id_Expiry_date').value = formatDate(data.Expiry_date);
    document.getElementById('id_Size').value = data.Size;
    document.getElementById('id_Unit').value = data.Unit;
    document.getElementById('id_Quantity').value = data.Quantity;
    document.getElementById('id_BT_Rate').value = data.BT_Rate;
    document.getElementById('id_BT_Final_Amount').value = data.BT_Final_Amount;
    document.getElementById('id_CGST').value = data.CGST;
    document.getElementById('id_SGST').value = data.SGST;
    document.getElementById('id_PU_Final_Amount').value = data.PU_Final_Amount;
    document.getElementById('id_MRP').value = data.MRP;
    document.getElementById('id_Cost_Price').value = data.Cost_Price;
    document.getElementById('id_Profit_percentage').value = data.Profit_percentage;
    document.getElementById('id_Selling_Price').value = data.Selling_Price;
}

document.addEventListener('DOMContentLoaded', function () {
    function calculateFinalAmount() {
        let total = 0;
        const rows = document.querySelectorAll('table.table-hover tbody tr');
        rows.forEach(row => {
            const puFinalAmount = parseFloat(row.querySelector('td:nth-child(12)').textContent) || 0;
            total += puFinalAmount;
        });
        document.getElementById('id_Final_Amount').textContent = total.toFixed(2);
    }

    // Call calculateFinalAmount on page load

    function calculateFinalAmount() {
    let total = 0;
    const rows = document.querySelectorAll('table.table-hover tbody tr');
    rows.forEach(row => {
        const puFinalAmount = parseFloat(row.querySelector('td:nth-child(12)').textContent) || 0;
        total += puFinalAmount;
    });
    document.getElementById('id_Final_Amount').value = total.toFixed(2); // Ensure this element is an input
    calculateRevisedAmount();
}
calculateFinalAmount();

// Recalculate final amount whenever the form is submitted or table data changes
document.getElementById('invoiceForm').addEventListener('submit', function (event) {
    event.preventDefault(); // Prevent the form from submitting immediately
    calculateFinalAmount();
    this.submit(); // Continue with form submission
});

// Ensure to call calculateFinalAmount after adding/deleting a product
function setDeleteActionAndSubmit(productId) {
    const actionTypeElement = document.getElementById('action_type');
    const productIdElement = document.getElementById('product_id');
    const formElement = document.getElementById('invoiceForm');

    if (actionTypeElement && productIdElement && formElement) {
        actionTypeElement.value = 'delete';
        productIdElement.value = productId;
        formElement.submit();
    } else {
        console.error("One or more elements are missing from the DOM.");
    }
}

window.setDeleteActionAndSubmit = function (productId) {
    setDeleteActionAndSubmit(productId);
    calculateFinalAmount(); // Recalculate after deletion
};
});

//Calculate Revised Amount
function calculateRevisedAmount(){
    var FinalAmount = parseInt(document.getElementById('id_Final_Amount').value) || 0;
    var AmountAdd = parseFloat(document.getElementById('id_Additions').value) || 0;
    var AmountDeducted = parseFloat(document.getElementById('id_Deductions').value) || 0;

    var RevisedAmount = FinalAmount + AmountAdd - AmountDeducted;
    document.getElementById('id_Revised_Amount').value = RevisedAmount.toFixed(2);
}

document.addEventListener('DOMContentLoaded', function(){
    var inputsRevisedAmount = document.querySelectorAll('#id_Additions, #id_Deductions');
    inputsRevisedAmount.forEach(function(input) {
        input.addEventListener('input', calculateRevisedAmount);
    });

    // Add event listeners to BT_Final_Amount for both calculations
    var FinalAmountInput = document.getElementById('id_Final_Amount');
    if (FinalAmountInput) {
        FinalAmountInput.addEventListener('input', calculateRevisedAmount);
    }
});

//---This where you need to change--
$(document).ready(function() {
    // Detect changes in invoice values
    $('.invoice-input').on('change', function() {
        var invoiceData = {
            invoiceId: $('#invoiceId').val(),
            fieldName: $(this).attr('name'),
            newValue: $(this).val()
        };

        // Send AJAX request to the server
        $.ajax({
            url: '/update-invoice',
            type: 'POST',
            data: JSON.stringify(invoiceData),
            contentType: 'application/json',
            success: function(response) {
                console.log('Invoice updated and cache re-created:', response);
            },
            error: function(xhr, status, error) {
                console.error('Error updating invoice:', error);
            }
        });
    });
});


//

function calculateCostPrice() {
        var ATFA = parseFloat(document.getElementById('id_PU_Final_Amount').value) || 0;
        var Quantity = parseFloat(document.getElementById('id_Quantity').value) || 0;

        var costprice = ATFA / Quantity;

        document.getElementById('id_Cost_Price').value = costprice.toFixed(2);
    }

    document.addEventListener('DOMContentLoaded', function() {
        var inputs = document.querySelectorAll('#id_Quantity , #id_CGST, #id_SGST , #id_BT_Rate, #id_BT_Final_Amount , #id_PU_Final_Amount');
        inputs.forEach(function(input) {
            input.addEventListener('input', calculateCostPrice);
        });
    });


function calculateSellingPrice() {
        var costPrice = parseFloat(document.getElementById('id_Cost_Price').value) || 0;
        var profitPercentage = parseFloat(document.getElementById('id_Profit_percentage').value) || 0;

        var profitAmount = costPrice * (profitPercentage / 100);
        var sellingPrice = costPrice + profitAmount;

        document.getElementById('id_Selling_Price').value = sellingPrice.toFixed(2);
    }

    document.addEventListener('DOMContentLoaded', function() {
        var inputs = document.querySelectorAll('#id_Cost_Price, #id_Profit_percentage, #id_Quantity , #id_CGST, #id_SGST , #id_BT_Rate, #id_BT_Final_Amount , #id_PU_Final_Amount');
        inputs.forEach(function(input) {
            input.addEventListener('input', calculateSellingPrice);
        });
    });
// For calculating profit percentage...
    function calculateProfitPercentage() {
            var costPrice = parseFloat(document.getElementById('id_Cost_Price').value) || 0;
            var sellingPrice = parseFloat(document.getElementById('id_Selling_Price').value) || 0;

            var profitPercentage = ((sellingPrice - costPrice) / costPrice) * 100;

            document.getElementById('id_Profit_percentage').value = profitPercentage.toFixed(2);
        }

        document.addEventListener('DOMContentLoaded', function() {
            var priceInputs = document.querySelectorAll('#id_Cost_Price, #id_Profit_percentage, #id_Quantity , #id_CGST, #id_SGST , #id_BT_Rate, #id_BT_Final_Amount , #id_PU_Final_Amount');
            priceInputs.forEach(function(input) {
                input.addEventListener('input', calculateSellingPrice);
            });

            document.getElementById('id_Selling_Price').addEventListener('input', calculateProfitPercentage);
        });


function refreshPage(invoiceId) {
        const refreshUrl = `/purchase_invoice_update_refresh/${invoiceId}`;
        window.location.href = refreshUrl;
    }

//
document.getElementById('updateButton').addEventListener('click', function(event) {
    document.getElementById('action_type').value = 'update_db';
});
</script>

{%endif%}

{%endblock%}